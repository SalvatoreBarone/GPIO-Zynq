<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zynq-7000 Driver Pack: uio.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Zynq-7000 Driver Pack
   &#160;<span id="projectnumber">3.2</span>
   </div>
   <div id="projectbrief">Implementazione C di device-driver per Xilinx Zynq-7000</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generato da Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Cerca');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Cerca');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('uio_8c-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">uio.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Il file <a class="el" href="uio_8c.html">uio.c</a> è un programma di esempio per l'interfacciamento con una periferica myGPIO. L'esempio mostra come possa, un programma userspace in esecuzione su sistema operativo Linux, interfacciarsi con un device myGPIO, interagendo con esso attraverso il driver UIO.</p>
<dl class="section warning"><dt>Avvertimento</dt><dd>Se nel device tree source non viene indicato <center>compatible = "generic-uio";</center> tra i driver compatibili con il device, il driver UIO non viene correttamente istanziato ed il programma non funzionerà.</dd></dl>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/mman.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="my_g_p_i_o_8h.html">myGPIO.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a0"></a><a class="code" href="uio_8c.html#a05909651fa170a63e98e3f8e13451b7b">howto</a>(<span class="keywordtype">void</span>) {</div><div class="line">    printf(<span class="stringliteral">&quot;Uso:\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;uio -d /dev/uioX -w|m &lt;hex-value&gt; -r\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;\t-m &lt;hex-value&gt;: scrive nel registro \&quot;mode\&quot;\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;\t-w &lt;hex-value&gt;: scrive nel registro \&quot;write\&quot;\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;\t-r: legge il valore del registro \&quot;read\&quot;\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;I parametri possono anche essere usati assieme.\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a1"></a><a class="code" href="uio_8c.html#ab6b18eb1bf7bc996599c06dc6dad8f53">parse_args</a>( <span class="keywordtype">int</span>         argc,</div><div class="line">                <span class="keywordtype">char</span>        **argv,</div><div class="line">                <span class="keywordtype">char</span>        **uio,          <span class="comment">// file uio da usare</span></div><div class="line">                uint8_t     *op_mode,       <span class="comment">// impostato ad 1 se l&#39;utente intende effettuare scrittuara su mode</span></div><div class="line">                uint32_t    *mode_value,    <span class="comment">// valore che l&#39;utente intende scrivere nel registro mode</span></div><div class="line">                uint8_t     *op_write,      <span class="comment">// impostato ad 1 se l&#39;utente intende effettuare scrittuara su write</span></div><div class="line">                uint32_t    *write_value,   <span class="comment">// valore che l&#39;utente intende scrivere nel registro write</span></div><div class="line">                uint8_t     *op_read)       <span class="comment">// impostato ad 1 se l&#39;utente intende effettuare lettura da read</span></div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> par;</div><div class="line">    <span class="keywordflow">while</span>((par = getopt(argc, argv, <span class="stringliteral">&quot;d:w:m:r&quot;</span>)) != -1) {</div><div class="line">        <span class="keywordflow">switch</span> (par) {</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span> :</div><div class="line">            *uio = optarg;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;w&#39;</span> :</div><div class="line">            *write_value = strtoul(optarg, NULL, 0);</div><div class="line">            *op_write = 1;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span> :</div><div class="line">            *mode_value = strtoul(optarg, NULL, 0);</div><div class="line">            *op_mode = 1;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span> :</div><div class="line">            *op_read = 1;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        default :</div><div class="line">            printf(<span class="stringliteral">&quot;%c: parametro sconosciuto.\n&quot;</span>, par);</div><div class="line">            <a class="code" href="uio_8c.html#a05909651fa170a63e98e3f8e13451b7b">howto</a>();</div><div class="line">            <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a2"></a><a class="code" href="uio_8c.html#a879d8b839631449ecb5bc4d0721432b6">gpio_op</a> (  <span class="keywordtype">void</span>*       vrt_gpio_addr,</div><div class="line">                uint8_t     op_mode,</div><div class="line">                uint32_t    mode_value,</div><div class="line">                uint8_t     op_write,</div><div class="line">                uint32_t    write_value,</div><div class="line">                uint8_t     op_read)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Indirizzo gpio: %08x\n&quot;</span>, (uint32_t)vrt_gpio_addr);</div><div class="line"></div><div class="line"><span class="preprocessor">    #ifdef __XIL_GPIO__</span></div><div class="line"><span class="preprocessor">#define MODE_OFFSET     4U</span></div><div class="line"><span class="preprocessor">#define WRITE_OFFSET    0U</span></div><div class="line"><span class="preprocessor">#define READ_OFFSET     8U</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <a name="_a3"></a><a class="code" href="structmy_g_p_i_o__t.html">myGPIO_t</a> gpio;</div><div class="line">    <a name="a4"></a><a class="code" href="group__bare-metal.html#ga588201358d1633c53535b288c9198531">myGPIO_Init</a>(&amp;gpio, (uint32_t)vrt_gpio_addr);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (op_mode == 1) {</div><div class="line"><span class="preprocessor">#ifdef __XIL_GPIO__</span></div><div class="line">        *((uint32_t*)(vrt_gpio_addr+<a name="a5"></a><a class="code" href="mygpiok_8c.html#a7a63b24ca5489eb3206598e3d90fe19c">MODE_OFFSET</a>)) = mode_value;</div><div class="line">        mode_value = *((uint32_t*)(vrt_gpio_addr+<a class="code" href="mygpiok_8c.html#a7a63b24ca5489eb3206598e3d90fe19c">MODE_OFFSET</a>));</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        <a name="a6"></a><a class="code" href="group__bare-metal.html#ga43e82eb0febd452635a438fbd9cb853b">myGPIO_SetMode</a>(&amp;gpio, mode_value, <a name="a7"></a><a class="code" href="group__bare-metal.html#gga76b849f0e0c05e7f9161bdb33396f2b1a2d66976280eb7595a42c631683bdfad6">myGPIO_write</a>);</div><div class="line">        <a class="code" href="group__bare-metal.html#ga43e82eb0febd452635a438fbd9cb853b">myGPIO_SetMode</a>(&amp;gpio, ~mode_value, <a name="a8"></a><a class="code" href="group__bare-metal.html#ggaf634fe4a0e1eab8da5000b72d6ad362ba98cde80dbda025bd1ae7231c76b55674">myGPIO_reset</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        printf(<span class="stringliteral">&quot;Scrittura sul registro mode: %08x\n&quot;</span>, mode_value);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (op_write == 1) {</div><div class="line"><span class="preprocessor">#ifdef __XIL_GPIO__</span></div><div class="line">        *((uint32_t*)(vrt_gpio_addr+<a name="a9"></a><a class="code" href="mygpiok_8c.html#a77d96306ed0e813f93c4c3f98b970b86">WRITE_OFFSET</a>)) = write_value;</div><div class="line">        write_value = *((uint32_t*)(vrt_gpio_addr+<a class="code" href="mygpiok_8c.html#a77d96306ed0e813f93c4c3f98b970b86">WRITE_OFFSET</a>));</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        <a name="a10"></a><a class="code" href="group__bare-metal.html#ga9d9ce9d2db7d77a588da4a3749f2f24d">myGPIO_SetValue</a>(&amp;gpio, write_value, <a name="a11"></a><a class="code" href="group__bare-metal.html#ggaf634fe4a0e1eab8da5000b72d6ad362ba10d296f3711d01189cc6c2d87f7c9149">myGPIO_set</a>);</div><div class="line">        <a class="code" href="group__bare-metal.html#ga9d9ce9d2db7d77a588da4a3749f2f24d">myGPIO_SetValue</a>(&amp;gpio, ~write_value, <a class="code" href="group__bare-metal.html#ggaf634fe4a0e1eab8da5000b72d6ad362ba98cde80dbda025bd1ae7231c76b55674">myGPIO_reset</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        printf(<span class="stringliteral">&quot;Scrittura sul registro write: %08x\n&quot;</span>, write_value);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (op_read == 1) {</div><div class="line">        uint32_t read_value = 0;</div><div class="line"><span class="preprocessor">#ifdef __XIL_GPIO__</span></div><div class="line">        read_value = *((uint32_t*)(vrt_gpio_addr+<a name="a12"></a><a class="code" href="mygpiok_8c.html#ad32c3a5b42163e171daccde5b5d5de02">READ_OFFSET</a>));</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">        read_value = <a name="a13"></a><a class="code" href="group__bare-metal.html#gac35776cd6652f7b932a132f3f6959a11">myGPIO_GetRead</a>(&amp;gpio);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        printf(<span class="stringliteral">&quot;Lettura dat registro read: %08x\n&quot;</span>, read_value);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a14"></a><a class="code" href="uio_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div><div class="line">    <span class="keywordtype">char</span>* uio_file = 0;         <span class="comment">// nome del file uio</span></div><div class="line">    uint8_t op_mode = 0;        <span class="comment">// impostato ad 1 se l&#39;utente intende effettuare scrittuara su mode</span></div><div class="line">    uint32_t mode_value;        <span class="comment">// valore che l&#39;utente intende scrivere nel registro mode</span></div><div class="line">    uint8_t op_write = 0;       <span class="comment">// impostato ad 1 se l&#39;utente intende effettuare scrittuara su write</span></div><div class="line">    uint32_t write_value;       <span class="comment">// valore che l&#39;utente intende scrivere nel registro write</span></div><div class="line">    uint8_t op_read = 0;        <span class="comment">// impostato ad 1 se l&#39;utente intende effettuare lettura da read</span></div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;%s build %d\n&quot;</span>, argv[0], BUILD); <span class="comment">// BUILD viene definita in compilazione</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="uio_8c.html#ab6b18eb1bf7bc996599c06dc6dad8f53">parse_args</a>(argc, argv, &amp;uio_file, &amp;op_mode, &amp;mode_value, &amp;op_write, &amp;write_value, &amp;op_read) == -1)</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    <span class="keywordflow">if</span> (uio_file == 0) {</div><div class="line">        printf(<span class="stringliteral">&quot;è necessario specificare il device UIO col quale interagire.\n&quot;</span>);</div><div class="line">        <a class="code" href="uio_8c.html#a05909651fa170a63e98e3f8e13451b7b">howto</a>();</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">    <span class="keywordtype">int</span> descriptor = open (uio_file, O_RDWR);</div><div class="line">    <span class="keywordflow">if</span> (descriptor &lt; 1) {</div><div class="line">        perror(argv[0]);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">    uint32_t page_size = sysconf(_SC_PAGESIZE);     <span class="comment">// dimensione della pagina</span></div><div class="line">    <span class="keywordtype">void</span>* vrt_gpio_addr = mmap(NULL, page_size, PROT_READ | PROT_WRITE, MAP_SHARED, descriptor, 0);</div><div class="line">    <span class="keywordflow">if</span> (vrt_gpio_addr == MAP_FAILED) {</div><div class="line">        printf(<span class="stringliteral">&quot;Mapping indirizzo fisico - indirizzo virtuale FALLITO!\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">    <a class="code" href="uio_8c.html#a879d8b839631449ecb5bc4d0721432b6">gpio_op</a>(vrt_gpio_addr, op_mode, mode_value, op_write, write_value, op_read);</div><div class="line"></div><div class="line">    munmap(vrt_gpio_addr, page_size);</div><div class="line">    close(descriptor);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generato Sab 29 Lug 2017 11:19:44 per Zynq-7000 Driver Pack da
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
